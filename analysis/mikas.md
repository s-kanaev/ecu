# МИКАС 7

## Железо

### Питание

Клемма 27 - питание от зажигания.
Именитая и известная клемма "15" на замке зажигания.
Взрослые дяди её лично видели.
Мне же, увы, не довелось её лицезреть лично. А так хотелось!

### Датчики

#### Вход ДПКВ

Ожидание (возможного) - выход датчика (или его вход в 'мозок') логический. Смысл сигнала -
срез (переход `0-1` или `1-0`) есть сообщение о провороте коленвала на некую дельту.
Должно быть обозначение "ноля" или "начала отсчёта" (ВМТ первого цилиндра).

Ожидание (невозможного, ибо три провода всего) - выход есть готовое значение положения коленвала (энкодер).

| Название | Клемма |
| -------- | ------ |
| "+"      | 49     |
| "-"      | 48     |

Назначение компонентов:
* C17 - шунт на входе;
* R15 - разрядник для C17;
* R17 - ограничитель тока через VD1.1, VD1.2;
* C16, C22 - ??? // приведение к имеющемуся "нулю"?;
* DA2-1 - триггер Шмитта;
* VD1.1, VD1.2 - ограничитель входного напряжения, диоды типа BAS70 или 1N4148, `V_f = 0.5 V (approx.)`
* R12, R13 - задают ширину петли гистерезиса на DA2-1;
* R19, R20 - делитель напряжения (`1-1 => 2.5 V`), который:
    - задаёт центр петли гистерезиса;
    - задаёт смещение ограничителя входного напряжения.

Ширина петли гистерезиса: `H = (R12 / R13) * 5V = 0.1 V (approx.)`.
Верхний порог `V_high = 2.5 + 0.1 = 2.6 V`, нижний порог `V_low = 2.5 - 0.1 = 2.4 V`.

Ограничитель входного напряжения: `2.5 - 0.5 ... 2.5 + 0.5 = 2 .. 3 V`.
Преобразование происходит из диапазона `-250 .. 250 V` в диапазон `2 .. 3 V`
посредством ограничения (обрезания) до `-0.5 .. 0.5 V` и смещение на `+2.5 V`.

DA2-1 преобразует имеющиеся `2 .. 3 V` в логические уровни (`0 V` и `+5 V`).
Порог переключения в 'единицу' - `2.6 V`, в 'ноль' - `2.4 V`.

Разность напряжений на выходе ДПКВ, равная `0 V`, говорит о прохождении середины зуба.
Граница перехода выхода триггера DA2-1 в любую сторону говорит об уже случившемся прохождении середины зуба.
Вот такая бяка...

Выход триггера DA2-1 уходит напрямую в 'мозок' SAF-C509L на ногу `P1.3`.

ВМТ первого и четвёртого цилиндров совпадает с 20-м (после выреза) зубом синхродиска.
Один зуб, вместе с промежутком до следующего, имеет ширину 6 градусов оборота ДПКВ.
На синхродиске 58 зубов (схема `60 - 2`).

Ожидание (возможного) пока оправдалось. Начало отсчёта имеется. Правда, оно не совсем ВМТ первого цилиндра.
Точнее, совсем не ВМТ. Возможное объяснение -- так сделано для лучшего удобства счёта.


#### Вход ДПРВ

Ожидание - выход логический, срез 0-1 сигнализирует о том, что следующее начало отсчёта совпадёт с ВМТ первого цилиндра.

Из "камасутры". ДПРВ позволяет определить ВМТ такта сжатия (перед рабочим ходом) первого цилиндра.
При положении середины отметчика (на распредвале) относительно оси ДПРВ коленвал должен быть повёрнут в положение,
при котором середина первого после выреза зуба синхродиска совпадает с осью ДПКВ.
Ширина отметчика распредвала составляет не менее `24 +/- 1` градус положения распредвала или `12 +/- 0.5` градус положения коленвала.

| Название | Клемма |
| -------- | ------ |
| Сигнал   | 8      |

Назначение компонентов:
* C30, R26, R30, C31 - фильтр.

Сигнал - проходит через ФВЧ с частотой среза около 7961Гц.

Считываются показания датчика с ноги `P1.2` мозгов SAF-C509L.

Сигнал с ДПРВ трактуется только как "есть/нет".
Такой сигнал формируется лишь однажды за два оборота коленвала.

Один раз за два оборота колена датчик выдаст сигнал.
При частоте вращения коленвала в `5k` датчик выдаст сигнал с частотой `2.5 kHz`.
Что вполне укладывается в частоту среза.

Ожидание пока оправдалось.


#### Вход ДМРВ

Питание датчик получает от главного реле. Оттуда же питается нога 37 мозгов.

Схем две. Для плёночного и нитевого ДМРВ.

Ожидание - используется аналоговый вход "мізків" (процессора).
Аналоговое значение преобразуется в значение расхода воздуха (кг/час) через тарировочную таблицу.
Прожиг управляется от мозгов через реле.

| Название                          | Клемма |
| --------------------------------- | ------ |
| "+"                               | 7      |
| "-"                               | 6      |
| Прожиг                            | 31     |
| Потенциометр регулировки CO       | 36     |

##### Плёнка

Клемма потенциометра корректировки CO заземлена через конденсатор.
"Минус" опущен на землю через перемычку.
"Плюс" - проходит через ФВЧ с частотой среза около 361Гц и попадает на ногу `P8.3` процессора.

Ожидания пока оправдались.

##### Нитка

Выходы потенциометра и "плюса" значения массового расхода воздуха включены по схеме
дифференциального усилителя относительно "минуса", который, кстати, опущен на "ноль" через перемычку.

Дифф-усилители имеют некий гистерезис.

Потенциометр заходит на ногу `P8.0` процессора. Значение расхода - на ногу `P8.3`.

Прожиг управляется аналогично "плёнке".

Ожидания пока оправдались.

##### Прожиг

Прожиг управляется через отключением ноги `OUT4` ИС HIP0045 (переход в состояние высокого импеданса).

Этот HIP0045 управляется мозгами так:

| HIP0045 input | SAF-C509L output |
| ------------- | ---------------- |
| `MOSI`        | `P5.5`           |
| `MISO`        | `P5.7`           |
| `CLK`         | `P5.6`           |
| `!CE`         | `P6.6`           |
| `IN0`         | `P5.4`           |
| `IN1`         | `P9.1`           |
| `!RESET`      | Софья Львовна, вы будете смеятся, но оно болтается в воздухе как то НЛО |


#### Вход ДПДЗ

Ожидание - используется аналоговый вход процессора.

Из "камасутры". Сам датчик представляет собой делитель напряжения.
При полностью закрытом дросселе выходное напряжение в пределах `0.25 .. 0.65 V`.
При полностью открытом - напряжение на выходе пределах `3.9 .. 4.7 V`.
Сопротивление - в пределах `1.8 .. 2 kOhm`.

| Название | Клемма |
| -------- | ------ |
| Сигнал   | 53     |
| `+U`     | 12     |
| `GND`    | 30     |

Назначение компонентов:
 * C4, R4, R1, C5 - фильтр.

Сигнал - проходит через ФВЧ с частотой среза около 361Гц и попадает на ногу `P8.4` процессора.

Ожидания - пока оправдались.


#### Вход ДТВ/ДТОЖ

Ожидание - используется аналоговый вход процессора.

Из "камасутры". Датчик представляет собой залитую компаундом ИС [К1019ЕП1](http://tec.org.ru/board/k1019cht1/139-1-0-508).
Ближайший аналог - LM135 (по слухам, не сверял).

| Название     | Клемма |
| ------------ | ------ |
| Сигнал ДТВ   | 44     |
| Сигнал ДТОЖ  | 45     |

Сигнальная клемма одновременно есть и питательная. Однако, питание датчику нужно подавать от источника тока.
Характеристика датчика линейная при питании датчика током в `1 mA`.

Сигнал ДТВ - проходит через ФВЧ с частотой среза около 361Гц и попадает на ногу `P8.6` процессора.
Сигнал ДТОЖ - аналогично и попадает на ногу `P7.7` процессора.

Каждый датчик питается от источника питания `5 V` через сопротивление `1.8 kOhm`.
То есть предельный ток - `2.78 mA`. Маленько не сходится ток питания с предельным для ИС (`0.45 .. 2.5 mA`).
Однако, по тарировочной таблице с номинальным током (`1 mA`), при температуре `-45 C`
разность потенциалов на выходе составит `2.23 ... 2.33 V`. Получаем сопротивление `2230 .. 2330 Ohm`.
В купе с имеющимся `1.8 kOhm` получим ток `1 mA (approx)`.
При температуре `125 C` разность потенциалов на выходе составит `3.95 .. 4.01 V`.
Это даёт сопротивление `3950 .. 4010 Ohm`.
В совокупности с имеющимся `1.8 kOhm` это даёт ток `0.86 mA (approx)`.

Ожидания пока оправдались.


#### Вход ДД

Ожидание - используется логический вход процессора. Сигнал `1` говорит, что имеет место детонация.

| Название     | Клемма |
| ------------ | ------ |
| Сигнал ДД1   | 11     |
| Сигнал ДД2   | 41     |

Сигнал датчика через конденсатор (для отсечения постоянной составляющей) поступает на вход ИС HIP9010 или HIP9011.

Эта ИС управляется "мозгами" так:

| `HIP9010` / `HIP9011` | SAF-C509L |
| --------------------- | --------- |
| `MISO`                | `NC`      |
| `MOSI`                | `P1.5`    |
| `SCK`                 | `P9.6`    |
| `OSCIN`               | `P1.6`    |
| `OSCOUT`              | `NC`      |
| `INTEGRATE/!HOLD`     | `P1.4`    |
| `INTEGRAL OUTPUT`     | `P7.0`    |
| `!TEST`               | `NC`      |
| `!CS`                 | `P9.7`    |

Ноги `S0IN`, `S0FB` и соответствующие входы второго канала использованы по назначению для подключения обоих датчиков.

Датчик пъезоэлектрический.
Сигнал с датчика не логический, а аналоговый. В добавок, двигатель - штука вибрирующая постоянно.
В рабочем режиме датчик генерирует ЭДС с некоторой амплитудой и характеристикой. Назовём этот сигнал штатным.
Детонация сопровождается (или предваряется) неким "шумом" среди "штатного" сигнала.

Суть работы HIP9010/HIP9011 заключается в фильтрации входного сигнала с последующим интегрированием за некий
промежуток времени. Входы `SPI (MOSI, SCK)` использутся для установки параметров фильтра и длительности промежутка
времени, за который нужно делать интегрирование. Выход - аналоговый.

Ожидания - разбились о скалы действительности и физики. Используется аналоговый вход.
Превышение интегрального значения некоего порога говорит а наличии детонации.


#### Вход L-зонда

Ожидания - используется аналоговый вход процессора.

| Название     | Клемма |
| ------------ | ------ |
| Сигнал 1     | 28     |
| Сигнал 2     | 39     |

По значению с датчика меняется смесеобразование (изменение длительности впрыска и/или кол-ва добавочного воздуха).

Выход датчика проходит через ФВЧ с частотой среза `1592 Hz (approx.)` и далее на ногу `P7.1` процессора.
Второй L-зонд проходит через такой же фильтр и далее на ногу `P7.2`.

Ожидания - пока оправдались.

#### Вход "запрос включения кондиционера"

Ожидания - используется логический вход процессора.

| Название     | Клемма |
| ------------ | ------ |
| Сигнал       | 40     |

Выход "запроса" проходит через ФВЧ и поступает на ногу `P7.6` процессора.

Ожидания - пока оправдались.


#### Вход клапана рециркуляции (СРОГ) / ДАД

Из разных источников - клемма 50 это либо сигнал с клапана рециркуляции либо сигнал с ДАД.
Питание этот "клапан ДАД" получает от клеммы 47 `+5 V`.

| Название     | Клемма |
| ------------ | ------ |
| Сигнал       | 50     |
| `+U`         | 47     |

Ожидания - используется аналоговый вход процессора.

Сигнал проходит через ФВЧ с частотой среза `361 Hz (approx.)` и попадает на ногу `P8.5` процессора.

Ожидания - пока да (c) (Бородатый анекдот).



### Исполнительные механизмы

#### Реле

##### Главное реле

Реле управляется с клеммы 46 подачей "минуса" (включением соответствующего выхода) с ноги `OUT5` ИС HIP0045.

##### Реле ЭБН

Реле управляется с клеммы 3 подачей "минуса" (включением соответствующего выхода) с ноги `OUT7` ИС HIP0045.

##### Реле муфты электровентилятора

Реле управляется с клеммы 33 отключением ноги `OUT3` ИС HIP0045 (переход в состояние высокого импеданса).

##### Реле муфты кондиционера

Реле управляется с клеммы 25 отключением ноги `OUT2` ИС HIP0045 (переход в состояние высокого импеданса).


#### Зажигание

Управляются катушки с клемм 1 и 20 и клеммой 27.
Управление производится через ИС TPS2814 и полевой транзистор (в ключевом режиме).
Транзистор КЗ 1/4 - с ноги `OUT2`, КЗ 2/3 - с ноги `OUT1`.
Когда выход ИС TPS2814 активен (`+5 V`) полевик открыт (в насыщенном состоянии) и замыкает клемму 1 (20) на землю.
В противном случае полевик закрыт и на клемму 1 (20) поступает напряжение `+12 V`.
В момент переключения должно произойти искрообразование. Катушка заряжается, как-бы отрицательным напряжением.

Управляется TPS2814 так:

| TPS2814 | SAF-C509L |
| ------- | --------- |
| `IN1`   | `RESO`    |
| `IN2`   | `RESO`    |
| `!IN1`  | `P5.0`    |
| `!IN2`  | `P5.1`    |

Неисправности определяются посредством считывания напряжения с ноги `P7.5` (`P7.4`).


#### Смесеобразование

##### Воздух: РДВ aka РХХ

Управляется с клемм 4 (закрытие) и 26 (открытие). Питание от главного реле.

У РХХ две обмотки, три вывода - один вывод общий для обмоток. Общий вывод - "плюс" (`+12 V`).
Управление "минусом". "Минус" заводится на клемму 4 или 26.

Питание ("минус") на клеммы 4 и 26 подаётся с ИС TLE5216G/MC33385DH с выходов `OUT3` и `OUT1` соответственно.

Управление этой ИС выполняется так:

| TLE5216G | SAF-C509L |
| -------- | --------- |
| `IN1`    | `P1.1`    |
| `IN2`    | `P4.4`    |
| `IN3`    | `P1.0`    |
| `IN4`    | `P4.5`    |
| `!RESET` | `RESO`    |
| `DI`     | `+5 V`    |
| `DO`     | `P9.0`    |
| `CLK`    | `P4.6`    |
| `!CS`    | `P6.7`    |

##### Топливо: форсунки

Форсунки получают питание (`+12 V`) от главного реле.
Включение управляется подачей минуса.

Форсунки управляются с клемм:

| Форсунка | Клемма |
| -------- | ------ |
| 1        | 17     |
| 2        | 16     |
| 3        | 35     |
| 4        | 34     |

Минус подаётся на управляющие клеммы с ИС TLE5216G/MC33385DH с выходов `OUT2`, `OUT3`,
`OUT1`, `OUT4` для первой, второй, третьей, четвёртой форсунок соответственно.

Управление этой ИС выполняется так:

| TLE5216G | SAF-C509L |
| -------- | --------- |
| `IN1`    | `P4.2`    |
| `IN2`    | `P4.0`    |
| `IN3`    | `P4.1`    |
| `IN4`    | `P4.3`    |
| `!RESET` | `RESO`    |
| `DI`     | `+5 V`    |
| `DO`     | `P4.7`    |
| `CLK`    | `P4.6`    |
| `!CS`    | `P6.7`    |


#### Продувка адсорбера и клапан СРОГ

Управление производится с клемм 5 (продувка адсорбера) и 23 (клапан СРОГ).

Управляются всё той же (первой) ИС TLE5216G/MC33385DH.

Управление всё так же минусом в силу логики работы данной ИС.


#### Диагностическая лампа

Диагностическая лампа зажигается подачей минуса (включением соответствующего выхода) от ИС HIP0045 с ноги `OUT6` на клемму 22.


#### Тахометр (водительский ?)

Клемма 43 (D) управляется переходом в состояние высокого импеданса ноги `OUT0` ИС HIP0045.

На клемму 38 (A) поступает интегрированное RC-цепочкой напряжение с клемм 1 и 20, управляющих катушками зажигания.


#### Расходомер топлива

Клемма 32 управляется переходом в состояние высокого импеданса ноги `OUT1` ИС HIP0045.


### Итог по железу

#### HIP0045

| HIP0045       | SAF-C509L        | Клемма мозгов | Назначение            | Способ подачи сигнала |
| ------------- | ---------------- | ------------- | --------------------- | --------------------- |
| `MOSI`        | `P5.5`           |
| `MISO`        | `P5.7`           |
| `CLK`         | `P5.6`           |
| `!CE`         | `P6.6`           |
| `IN0`         | `P5.4`           |
| `IN1`         | `P9.1`           |
| `!RESET`      | Софья Львовна, вы будете смеятся, но оно болтается в воздухе как то НЛО |
| `OUT0`        |                  | 43            | Тахометр (D)          | high-Z                |
| `OUT1`        |                  | 32            | Расходомер топлива    | high-Z                |
| `OUT2`        |                  | 25            | Реле кондиционера     | high-Z                |
| `OUT3`        |                  | 33            | Реле карлсона         | high-Z                |
| `OUT4`        |                  | 31            | Прожиг ДМРВ           | high-Z                |
| `OUT5`        |                  | 46            | Главное реле          | turn on               |
| `OUT6`        |                  | 26            | Диагностическая лампа | turn on               |
| `OUT7`        |                  | 3             | Реле ЭБН              | turn on               |


#### HIP9010/9011

#### TPS2814

Их две.
Одна для управления катушками зажигания. Вторая ...

#### TLE5216G/MC33385DH

> ВНИМАНИЕ! Эти две ИС не взаимозаменяемы по распиновке, хотя и работают одинаково. Каждая ИС имеет своё семейство аналогов.

Их две.
Одна для управления РХХ, продувкой адсорбера и клапаном СРОГ . Вторая - управляет форсунками.

Первая:

| TLE5216G | SAF-C509L | Клемма мозгов | Назначение         |
| -------- | --------- | ------------- | ------------------ |
| `IN1`    | `P1.1`    |
| `IN2`    | `P4.4`    |
| `IN3`    | `P1.0`    |
| `IN4`    | `P4.5`    |
| `!RESET` | `RESO`    |
| `DI`     | `+5 V`    |
| `DO`     | `P9.0`    |
| `CLK`    | `P4.6`    |
| `!CS`    | `P6.7`    |
| `OUT1`   |           | 26            | Открытие РХХ       |
| `OUT2`   |           | 5             | Продувка адсорбера |
| `OUT3`   |           | 4             | Закрытие РХХ       |
| `OUT4`   |           | 23            | Клапан СРОГ        |

Вторая:

| TLE5216G | SAF-C509L | Клемма мозгов | Назначение |
| -------- | --------- | ------------- | ---------- |
| `IN1`    | `P4.2`    |
| `IN2`    | `P4.0`    |
| `IN3`    | `P4.1`    |
| `IN4`    | `P4.3`    |
| `!RESET` | `RESO`    |
| `DI`     | `+5 V`    |
| `DO`     | `P4.7`    |
| `CLK`    | `P4.6`    |
| `!CS`    | `P6.7`    |
| `OUT1`   |           | 35            | Форсунка 3 |
| `OUT2`   |           | 17            | Форсунка 1 |
| `OUT3`   |           | 16            | Форсунка 2 |
| `OUT4`   |           | 34            | Форсунка 4 |

#### SAF-C509L

#### Вопросы

Ноги `P5` процессора - показывают ли диагностическое слово?


## Прошивка


